<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUDx Workbench v2</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; line-height: 1.6; color: #333; }
        .hidden { display: none; }
        #status-bar { 
            padding: 15px; 
            background: #e9ecef; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            border-left: 5px solid #0d6efd;
        }
        #data-container { 
            background: #fff; 
            border: 1px solid #dee2e6; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        ul { list-style: none; padding: 0; }
        li { 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            font-family: monospace;
        }
        button { 
            padding: 8px 16px; 
            cursor: pointer; 
            background: #0d6efd; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            margin-right: 5px;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .nav-controls { margin-top: 20px; display: flex; align-items: center; gap: 15px; }
    </style>
</head>
<body>

    <div id="status-bar">
        <strong>System-Status:</strong> <span id="auth-status">Initialisiere Firebase...</span>
    </div>

    <main id="app-content" class="hidden">
        <h1>CRUDx Workbench</h1>
        <p>Aktuelle Seite aus URL-Parameter <code>p</code>: <strong id="display-page">-</strong></p>
        
        <div id="data-container">
            Warte auf Daten-Abfrage...
        </div>
    </main>

    <script type="module">
        // Firebase Module laden
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, limit, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Deine Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyDaEMhzeKaYJEV2INM-pRtUBNW0ZS2LHwE",
            authDomain: "crudx-e0599.firebaseapp.com",
            projectId: "crudx-e0599",
            storageBucket: "crudx-e0599.appspot.com",
            messagingSenderId: "367332402422",
            appId: "1:367332402422:web:7f6f7d0a5e8b"
        };

        // Instanzen starten
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Globaler App-Status
        const state = {
            perPage: 5,
            currentPage: 1
        };

        // --- 1. DER GATEKEEPER (Zugangskontrolle) ---
        onAuthStateChanged(auth, async (user) => {
            const statusEl = document.getElementById('auth-status');
            
            if (user) {
                statusEl.textContent = `Bereit. Angemeldet als ${user.isAnonymous ? 'Anonymus' : user.email}`;
                document.getElementById('app-content').classList.remove('hidden');
                
                // Sobald wir sicher eingeloggt sind, starten wir die Logik
                runAppLogic();
            } else {
                statusEl.textContent = "Authentifizierung läuft...";
                signInAnonymously(auth).catch(err => {
                    statusEl.textContent = "Fehler: " + err.message;
                });
            }
        });

        // --- 2. DIE LOGIK (URL-First Paging) ---
        async function runAppLogic() {
            // Seite aus der URL auslesen (z.B. ?p=3)
            const params = new URLSearchParams(window.location.search);
            state.currentPage = parseInt(params.get('p')) || 1;
            
            // Anzeige aktualisieren
            document.getElementById('display-page').textContent = state.currentPage;

            // Daten abrufen
            await fetchPage(state.currentPage);
        }

        async function fetchPage(page) {
            const container = document.getElementById('data-container');
            container.innerHTML = "<em>Rufe Dokumente ab...</em>";

            try {
                // Wir nutzen ein einfaches Query mit Limit, um Quota zu sparen
                const collectionRef = collection(db, "kv-store");
                
                // HINWEIS: Für echtes Paging über tausende Docs nutzt man startAfter()
                // Hier implementieren wir die Basis-Struktur
                const q = query(collectionRef, limit(state.perPage));
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = "Keine Daten in der Collection 'kv-store' gefunden.";
                    return;
                }

                // Liste bauen
                let html = `<h3>Dokumente (Limit ${state.perPage}):</h3><ul>`;
                snapshot.forEach(doc => {
                    html += `<li>ID: <strong>${doc.id}</strong></li>`;
                });
                html += `</ul>`;
                
                // Navigationselemente
                html += `
                    <div class="nav-controls">
                        <button onclick="changePage(-1)" ${page <= 1 ? 'disabled' : ''}>Zurück</button>
                        <span>Seite ${page}</span>
                        <button onclick="changePage(1)">Weiter</button>
                    </div>
                `;
                
                container.innerHTML = html;

            } catch (err) {
                console.error(err);
                container.innerHTML = `<span style="color:red">Fehler beim Laden: ${err.message}</span>`;
            }
        }

        // --- 3. DIE NAVIGATION (URL ändern) ---
        window.changePage = (delta) => {
            const newPage = state.currentPage + delta;
            const url = new URL(window.location.href);
            
            // Setzt den URL Parameter 'p'
            url.searchParams.set('p', newPage);
            
            // Aktualisiert die Browser-Leiste OHNE die Seite neu zu laden
            window.history.pushState({}, '', url);
            
            // Startet die Logik neu mit dem neuen Wert
            runAppLogic();
        };
    </script>
</body>
</html>